package security

import (
	"testing"

	"github.com/stretchr/testify/assert"
)

func TestNewVulnerability(t *testing.T) {
	t.Parallel()

	vuln := NewVulnerability("CVE-2024-1234", "openssl").
		WithVersion("3.0.0").
		WithSeverity(SeverityCritical).
		WithCVSS(9.8).
		WithTitle("Buffer overflow").
		WithDescription("A buffer overflow vulnerability").
		WithFixedIn("3.0.1").
		WithReference("https://nvd.nist.gov/vuln/detail/CVE-2024-1234").
		WithProvider("brew").
		Build()

	assert.Equal(t, "CVE-2024-1234", vuln.ID)
	assert.Equal(t, "openssl", vuln.Package)
	assert.Equal(t, "3.0.0", vuln.Version)
	assert.Equal(t, SeverityCritical, vuln.Severity)
	assert.InDelta(t, 9.8, vuln.CVSS, 0.001)
	assert.Equal(t, "Buffer overflow", vuln.Title)
	assert.Equal(t, "A buffer overflow vulnerability", vuln.Description)
	assert.Equal(t, "3.0.1", vuln.FixedIn)
	assert.Equal(t, "https://nvd.nist.gov/vuln/detail/CVE-2024-1234", vuln.Reference)
	assert.Equal(t, "brew", vuln.Provider)
	assert.False(t, vuln.DetectedAt.IsZero())
}

func TestVulnerability_HasFix(t *testing.T) {
	t.Parallel()

	tests := []struct {
		name     string
		fixedIn  string
		expected bool
	}{
		{"with fix", "3.0.1", true},
		{"without fix", "", false},
	}

	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			t.Parallel()
			vuln := NewVulnerability("CVE-2024-1234", "test").
				WithFixedIn(tt.fixedIn).
				Build()
			assert.Equal(t, tt.expected, vuln.HasFix())
		})
	}
}

func TestVulnerability_IsCriticalOrHigh(t *testing.T) {
	t.Parallel()

	tests := []struct {
		severity Severity
		expected bool
	}{
		{SeverityCritical, true},
		{SeverityHigh, true},
		{SeverityMedium, false},
		{SeverityLow, false},
		{SeverityNegligible, false},
	}

	for _, tt := range tests {
		t.Run(string(tt.severity), func(t *testing.T) {
			t.Parallel()
			vuln := NewVulnerability("CVE-2024-1234", "test").
				WithSeverity(tt.severity).
				Build()
			assert.Equal(t, tt.expected, vuln.IsCriticalOrHigh())
		})
	}
}

func TestVulnerability_Summary(t *testing.T) {
	t.Parallel()

	vuln := NewVulnerability("CVE-2024-1234", "openssl").
		WithVersion("3.0.0").
		WithSeverity(SeverityCritical).
		WithTitle("Buffer overflow").
		Build()

	summary := vuln.Summary()
	assert.Contains(t, summary, "CVE-2024-1234")
	assert.Contains(t, summary, "openssl@3.0.0")
	assert.Contains(t, summary, "critical")
	assert.Contains(t, summary, "Buffer overflow")
}

func TestVulnerability_NVDLink(t *testing.T) {
	t.Parallel()

	tests := []struct {
		name     string
		id       string
		ref      string
		expected string
	}{
		{
			name:     "CVE ID",
			id:       "CVE-2024-1234",
			ref:      "",
			expected: "https://nvd.nist.gov/vuln/detail/CVE-2024-1234",
		},
		{
			name:     "Non-CVE ID",
			id:       "GHSA-1234",
			ref:      "https://github.com/advisories/GHSA-1234",
			expected: "https://github.com/advisories/GHSA-1234",
		},
	}

	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			t.Parallel()
			vuln := NewVulnerability(tt.id, "test").
				WithReference(tt.ref).
				Build()
			assert.Equal(t, tt.expected, vuln.NVDLink())
		})
	}
}

func TestVulnerabilities_BySeverity(t *testing.T) {
	t.Parallel()

	vulns := Vulnerabilities{
		NewVulnerability("CVE-1", "pkg1").WithSeverity(SeverityCritical).Build(),
		NewVulnerability("CVE-2", "pkg2").WithSeverity(SeverityHigh).Build(),
		NewVulnerability("CVE-3", "pkg3").WithSeverity(SeverityMedium).Build(),
		NewVulnerability("CVE-4", "pkg4").WithSeverity(SeverityLow).Build(),
	}

	highAndAbove := vulns.BySeverity(SeverityHigh)
	assert.Len(t, highAndAbove, 2)

	criticalOnly := vulns.BySeverity(SeverityCritical)
	assert.Len(t, criticalOnly, 1)
}

func TestVulnerabilities_CountBySeverity(t *testing.T) {
	t.Parallel()

	vulns := Vulnerabilities{
		NewVulnerability("CVE-1", "pkg1").WithSeverity(SeverityCritical).Build(),
		NewVulnerability("CVE-2", "pkg2").WithSeverity(SeverityCritical).Build(),
		NewVulnerability("CVE-3", "pkg3").WithSeverity(SeverityHigh).Build(),
		NewVulnerability("CVE-4", "pkg4").WithSeverity(SeverityMedium).Build(),
	}

	counts := vulns.CountBySeverity()
	assert.Equal(t, 2, counts[SeverityCritical])
	assert.Equal(t, 1, counts[SeverityHigh])
	assert.Equal(t, 1, counts[SeverityMedium])
	assert.Equal(t, 0, counts[SeverityLow])
}

func TestVulnerabilities_HasCritical(t *testing.T) {
	t.Parallel()

	withCritical := Vulnerabilities{
		NewVulnerability("CVE-1", "pkg1").WithSeverity(SeverityCritical).Build(),
	}
	assert.True(t, withCritical.HasCritical())

	withoutCritical := Vulnerabilities{
		NewVulnerability("CVE-1", "pkg1").WithSeverity(SeverityHigh).Build(),
	}
	assert.False(t, withoutCritical.HasCritical())
}

func TestVulnerabilities_Fixable(t *testing.T) {
	t.Parallel()

	vulns := Vulnerabilities{
		NewVulnerability("CVE-1", "pkg1").WithFixedIn("1.0.1").Build(),
		NewVulnerability("CVE-2", "pkg2").Build(), // No fix
		NewVulnerability("CVE-3", "pkg3").WithFixedIn("2.0.0").Build(),
	}

	fixable := vulns.Fixable()
	assert.Len(t, fixable, 2)
}

func TestVulnerabilities_ByPackage(t *testing.T) {
	t.Parallel()

	vulns := Vulnerabilities{
		NewVulnerability("CVE-1", "openssl").Build(),
		NewVulnerability("CVE-2", "openssl").Build(),
		NewVulnerability("CVE-3", "curl").Build(),
	}

	byPkg := vulns.ByPackage()
	assert.Len(t, byPkg["openssl"], 2)
	assert.Len(t, byPkg["curl"], 1)
}

func TestVulnerabilities_ExcludeIDs(t *testing.T) {
	t.Parallel()

	vulns := Vulnerabilities{
		NewVulnerability("CVE-2024-1234", "pkg1").Build(),
		NewVulnerability("CVE-2024-5678", "pkg2").Build(),
		NewVulnerability("CVE-2024-9999", "pkg3").Build(),
	}

	// Case insensitive exclusion
	filtered := vulns.ExcludeIDs([]string{"cve-2024-1234", "CVE-2024-9999"})
	assert.Len(t, filtered, 1)
	assert.Equal(t, "CVE-2024-5678", filtered[0].ID)

	// Empty exclusion list
	noFilter := vulns.ExcludeIDs(nil)
	assert.Len(t, noFilter, 3)
}

func TestVulnerabilities_Critical(t *testing.T) {
	t.Parallel()

	vulns := Vulnerabilities{
		NewVulnerability("CVE-1", "pkg1").WithSeverity(SeverityCritical).Build(),
		NewVulnerability("CVE-2", "pkg2").WithSeverity(SeverityHigh).Build(),
	}

	critical := vulns.Critical()
	assert.Len(t, critical, 1)
	assert.Equal(t, SeverityCritical, critical[0].Severity)
}

func TestVulnerabilities_High(t *testing.T) {
	t.Parallel()

	vulns := Vulnerabilities{
		NewVulnerability("CVE-1", "pkg1").WithSeverity(SeverityCritical).Build(),
		NewVulnerability("CVE-2", "pkg2").WithSeverity(SeverityHigh).Build(),
		NewVulnerability("CVE-3", "pkg3").WithSeverity(SeverityMedium).Build(),
	}

	high := vulns.High()
	assert.Len(t, high, 2) // Critical and High
}
